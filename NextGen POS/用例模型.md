## 处理销售

**范围**：NextGen POS 应用

**级别**：用户目标

**主要参与者**：收银员

**涉众及其关注点**：

- 收银员：希望能够准确、快速地输入，而且没有支付错误，因为如果少收货款，将从其薪水中扣除。
- 售货员：希望自动更新销售提成。
- 顾客：希望以最小代价完成购买活动并得到快速服务。希望便捷、清晰地看到所输入的商品项目和价格。希望得到购买凭证，以便退货。
- 公司：希望准确地记录交易，满足顾客要求。希望确保记录了支付授权服务的支付票据。希望有一定的容错性，即使在某些服务器构件不可用时（如远程信用卡验证），也能够完成销售。希望能够自动、快速地更新账务和库存信息。
- 经理：希望能够快速执行超控操作，并易于更正收银员的不当操作。
- 政府税收代理：希望能从每笔交易中抽取税金。可能存在多级税务代理，比如国家级，州级和县级。
- 支付授权服务：希望接收到格式和协议正确的数字授权请求。希望准确计算对商店的应付款。

**前置条件**：收银员必须经过确认和认证。

**后置条件**：存储销售信息。准确计算税金。更新账务和库存信息。记录提成。生成票据。记录支付授权的批准。

**基本流程**：

1. 顾客携带所购商品或服务到收银台通过POS机付款。

2. 收银员开始一次新的销售交易。

3. 收银员输入商品条码。

4. 系统逐条记录出售的商品，并显示该商品的描述、价格和累计额。价格通过一组价格规则来计算。

   *收银员重复3~4步，直到输入结束。*

5. 系统显示总额和所计算的税金。

6. 收银员告知顾客总额，并请顾客付款。

7. 顾客付款，系统处理支付。

8. 系统记录完整的销售信息，并将销售和支付信息发送到外部的账务系统（进行账务处理和提成）和库存系统（更新库存）。

9. 系统打印票据。

10. 顾客携带商品和票据离开（如果有）。

**替代流程**：

*a. 经理在任意时刻要求进行超控操作：

 	1. 系统进入经理授权模式。
 	2. 经理活收银员执行某一经理模式的操作。例如，变更现金结余，恢复其他登录者中断的销售交易，取消销售交易等。
 	3. 系统回复到收银员授权模式。

*b. 系统在任意时刻失败：

​	为了支持恢复和更正账务处理，要保证所有交易的敏感状态和事件都能从场景的任何一步中完全恢复。

 1. 收银员重启系统，登录，请求恢复上次状态。

 2. 系统重建上次状态。

    2a. 系统在恢复过程中检测到异常。

     	1. 系统向收银员提示错误，记录此错误，并进入一个初始状态。
    
     	2. 收银员开始一次新的销售交易。

1a. 客户或经理需要恢复一个中断的销售交易。

 1. 收银员执行恢复操作，并且输入ID以提取对应的销售交易。

 2. 系统显示被恢复的销售交易状态及其小计。

    2a. 未发现对应的销售交易。

     	1. 系统向收银员提示错误。
     	2. 收银员可能会开始一个新销售交易，并重新输入所有商品。

	3. 收银员继续该次销售交易（可能要输入更多的商品或处理支付）。

2-4a. 顾客告诉收银员其免税状况（例如，年长者、本国人等）。

 	1. 收银员进行核实，并输入免税状况编码。
 	2. 系统记录该状况编码（在计算税金时使用）。

3a. 无效商品ID（在系统中未发现）：

 1. 系统提示错误并拒绝输入该ID。

 2. 收银员响应该错误。

    2a. 商品ID可读（例如，数字型的UPC（通用产品代码））：

     1. 收银员手工输入商品ID。

     2. 系统显示商品项目的描述和价格。

        2a. 无效商品ID：系统提示错误。收银员尝试其他方式。

    2b. 系统内不存在该商品ID，但是该商品附有价签：

     	1. 收银员请求经理执行超控操作。
     	2. 经理执行相应的超控操作。
     	3. 收银员选择手工输入价格，输入价签上的价格，并且请求对该价目进行标准计税。（因为没有产品信息，计税引擎无法确定如何计税。）

    2c. 收银员通过执行<u>寻找产品帮助</u>以获取正确的商品ID及其价格。

    2d. 另外，收银员可以向其他员工询问商品ID或价格，然后手工输入ID或价格（参加以上内容）。

3b. 当有多个商品项目属于同一类别的时候（如5个汉堡包），不必记录每个商品项目的唯一标识：

 	1. 收银员可以输入类别的标识和商品的数量。

3c. 需要手工输入类别和价格（例如，花卉或纸牌及其价格）：

 	1. 收银员手工输入特定的类别代码及其价格。

3-6a. 顾客要求收银员从所购商品中去掉一项：

所去除商品的价格必须小于收银员权限，否则需要经理执行超控操作。

  1. 收银员输入商品ID并将其删除。

  2. 系统删除该项目并显示更新后的累计额。

     2a. 商品价格超过了收银员权限：

      	 1. 系统提示错误，并建议经理超控。
      	 2. 收银员请求经理超控，完成超控后，重做该操作。

3-6b. 顾客要求收银员取消销售交易：

 	1. 收银员在系统中取消销售交易。

3-6c. 收银员延迟销售交易：

 	1. 系统记录销售交易信息，使其能够在任何POS登录中恢复操作。
 	2. 系统显示用来恢复销售交易的“延迟票据”，其中包含商品项目和销售交易ID。

4a. 系统定义的商品价格不是顾客预期的价格（顾客对此产生抱怨并要求减价）：

 	1. 收银员请求经理批准。
 	2. 经理执行超控操作。
 	3. 收银员手工输入超控后的价格。
 	4. 系统显示新价格。

5a. 系统检测到与外部税务计算系统服务的通信故障：

 1. 系统在POS机节点上重启此服务，并继续操作。

    1a. 系统检测到该服务无法重启。

     	1. 系统提示错误。
    
     	2. 收银员手工计算和输入税金，或者取消该销售交易。

5b. 顾客声称他们符合打折条件：

 	1. 收银员提出打折请求。
 	2. 收银员输入顾客ID。
 	3. 系统按照打折规则显示折扣总计。

5c. 顾客要求兑现账户积分，用于此次销售交易：

 	1. 收银员提交积分请求。
 	2. 收银员输入顾客ID。
 	3. 系统按照打折规则显示折扣总计。

6a. 顾客要求现金付款，但所携现金不足：

 1. 顾客要求使用其他支付方式。

    1a. 顾客要求取消此次销售交易，收银员在系统上取消该销售交易。

7a. 现金支付：

 	1. 收银员输入收取的现金额。
 	2. 系统显示找零金额，并弹出现金抽屉。
 	3. 收银员放入收取的现金，并给顾客找零。
 	4. 系统记录该现金支付。

7b. 信用卡支付：

 1. 顾客输入信用卡账户信息。

 2. 系统显示其支付信息以备验证。

 3. 收银员确认。

    3a. 收银员取消付款步骤。

     	1. 系统回复到“商品输入”模式。

	4. 系统向外部支付授权服务系统发送支付授权请求，并请求批准该支付。

    4a. 系统检测到与外部系统协作时的故障：

     	1. 系统向收银员提示错误。
     	2. 收银员请求顾客更换支付方式。

	5. 系统收到批准支付的应答并提示收银员，同时弹出现金抽屉（以便放入签名后的信用卡支付票据）。

    5a. 系统收到拒绝支付的应答：

     	1. 系统向收银员提示支付被拒绝。
     	2. 收银员请求顾客更换支付方式。

    5b. 应答超时。

     	1. 系统提示收银员应答超时。
     	2. 收银员重试，或者请求顾客更换支付方式。

	6. 系统记录信用卡支付信息，其中包括支付批准。

	7. 系统显示信用卡支付的签名输入机制。

	8. 收银员请求顾客签署信用卡支付。顾客输入签名。

	9. 如果在纸质票据上签名，则收银员将该票据放入现金抽屉并关闭抽屉。

7c. 支票支付......

7d. 记账支付......

7e. 收银员取消支付步骤：

 	1. 系统回到“商品输入”模式。

7f. 顾客出示优惠券：

 1. 在处理支付之前，收银员记录每张优惠券，系统扣除相应金额。系统记录已使用的优惠券以备账务处理之用。

    1a. 输入的优惠券不适用于所购商品：

     	1. 系统向收银员提示错误。

9a. 存在商品回扣：

 	1. 系统对每个具有回扣的商品给出回扣表单和票据。

9b. 顾客索要赠品票据（不显示价格）：

 	1. 收银员请求赠品票据，系统给出赠品票据。

9c. 打印票据。

 	1. 如果系统能够检测到错误，给出提示。
 	2. 收银员更换纸张。
 	3. 收银员请求打印其他票据。

**特殊需求**：

- 使用大尺寸平面显示器触摸屏UI。文本信息可见距离为1米。
- 90%的信用卡授权响应时间小于30秒。
- 由于某些原因，我们希望在访问远程服务（如库存系统）失败的情况下具有比较强的恢复功能。
- 支持文本显示的语言国际化。
- 在步骤3和步骤7中能够加入可插拔的业务规则。
- ......

**技术与数据变元表**：

*a. 经理超控需要刷卡（由读卡器读取超控卡）或在键盘上输入授权码。

3a. 商品ID可以用条码扫描器（如果有条形码）或键盘输入。

3b. 商品ID可以使用UPC（通用产品代码）、EAN（欧洲物品编码）、JAN（日本物品编码）、或SKU（库存单位）等任何一种编码方式。

7a. 信用卡账户信息可以用读卡器或键盘输入。

7b. 记录在纸质票据上的信用卡支付签名。但我们预测，两年内会有许多顾客将希望使用数字签名。

**发生频率**：可能会不断地发生。

**未决问题**：

- 税法如何变化？
- 研究远程服务的恢复问题。
- 针对不同的业务需要怎样进行定制？
- 收银员是否必须在从系统注销后带走他们的现金抽屉？
- 顾客是否可以直接使用读卡器，还是必须由收银员完成？

